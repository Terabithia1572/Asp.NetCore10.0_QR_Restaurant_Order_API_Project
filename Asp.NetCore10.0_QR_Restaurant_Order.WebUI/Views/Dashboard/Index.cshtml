@model ResultDashboardSummaryDTO
@{
    ViewData["Title"] = "Yönetim Paneli";
    Layout = "~/Views/AdminLayout/Index.cshtml";
}

<!--
    RESTORAN YÖNETİM PANELİ (DASHBOARD)
    - QR ile verilen siparişlerin ve rezervasyonların özet ekranı
    - İleride: Orders, Tables, OrderDetails tabloları ile canlı veri bağlanacak
-->

<div class="row">
    <!-- GENEL CİRO (YILLIK) -->
    <div class="col-lg-6">
        <div class="card bg-white p-20 rounded-10 border border-white mb-4">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                <h3>Genel Ciro</h3>

                <div class="dropdown select-dropdown without-border">
                    <button class="dropdown-toggle bg-transparent text-secondary fs-15" data-bs-toggle="dropdown" aria-expanded="false">
                        2025 Yılı
                    </button>

                    <ul class="dropdown-menu dropdown-menu-end bg-white border-0 box-shadow rounded-10" data-simplebar>
                        <li><button class="dropdown-item text-secondary">2025 Yılı</button></li>
                        <li><button class="dropdown-item text-secondary">2024 Yılı</button></li>
                        <li><button class="dropdown-item text-secondary">2023 Yılı</button></li>
                    </ul>
                </div>
            </div>

            <!-- Buraya yıllık ciro grafiği (ApexChart): Günlük / Aylık ciro -->
            <div id="total_sales_chart" style="margin-bottom: -16px; margin-top: -1.5px;"></div>
        </div>
    </div>

    <!-- SİPARİŞ / MİSAFİR / GÜNLÜK CİRO ÖZETLERİ -->
    <div class="col-lg-6 col-xxl-3 col-xxxl-6">
        <div class="row">
            <!-- Toplam Sipariş -->
            <div class="col-md-6 col-lg-12">
                <div class="card bg-white p-20 rounded-10 border border-white mb-4">
                    <div class="d-flex">
                        <div class="flex-grow-1">
                            <h3 class="mb-10">Toplam Sipariş</h3>
                            <h2 class="fs-26 fw-medium mb-0 lh-1" id="totalOrderCount">
                                @Model.TotalOrderCount
                            </h2>
                        </div>
                        <div class="flex-shrink-0 ms-3">
                            <div class="bg-primary text-white text-center rounded-circle d-block" style="width: 75px; height: 75px; line-height: 105px;">
                                <i class="material-symbols-outlined fs-40">shopping_basket</i>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center" style="margin-top: 21px;">
                        <p class="mb-0 fs-14">Son siparişlerde artış</p>
                        <span class="d-flex align-content-center gap-1 bg-success bg-opacity-10 border border-success" style="padding: 3px 5px;">
                            <i class="material-symbols-outlined fs-14 text-success">trending_up</i>
                            <span class="lh-1 fs-14 text-success">%</span>
                        </span>
                    </div>
                </div>

            </div>

            <!-- Toplam Misafir / Rezervasyon -->
            <div class="col-md-6 col-lg-12">
                <div class="card bg-white p-20 rounded-10 border border-white mb-4">
                    <div class="d-flex">
                        <div class="flex-grow-1">
                            <h3 class="mb-10">Toplam Misafir</h3>
                            <h2 class="fs-26 fw-medium mb-0 lh-1" id="totalGuestCount">
                                @Model.TotalGuestCount
                            </h2>
                        </div>
                        <div class="flex-shrink-0 ms-3">
                            <div class="bg-info text-white text-center rounded-circle d-block" style="width: 75px; height: 75px; line-height: 105px;">
                                <i class="material-symbols-outlined fs-40">diversity_2</i>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center" style="margin-top: 21px;">
                        <p class="mb-0 fs-14">Toplam ağırlanan kişi sayısı</p>
                        <span class="d-flex align-content-center gap-1 bg-danger bg-opacity-10 border border-danger" style="padding: 3px 5px;">
                            <i class="material-symbols-outlined fs-14 text-danger">trending_down</i>
                            <span class="lh-1 fs-14 text-danger"></span>
                        </span>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- GÜNLÜK CİRO + ÖZET -->
    <div class="col-xl-12 col-xxl-3 col-xxxl-12">
        <div class="row">
            <!-- Günlük Ciro -->
            <div class="col-md-6 col-xxxl-6 col-xxl-12">
                <div class="card bg-white p-20 rounded-10 border border-white mb-4">
                    <div class="d-flex">
                        <div class="flex-grow-1">
                            <h3 class="mb-10">Bugünkü Ciro</h3>
                            <h2 class="fs-26 fw-medium mb-0 lh-1" id="todayRevenue">
                                @Model.TodayRevenue.ToString("C0", new System.Globalization.CultureInfo("tr-TR"))
                            </h2>
                        </div>
                        <div class="flex-shrink-0 ms-3">
                            <div class="bg-warning text-white text-center rounded-circle d-block" style="width: 75px; height: 75px; line-height: 116px;">
                                <i class="material-symbols-outlined fs-50">attach_money</i>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center" style="margin-top: 23px;">
                        <p class="mb-0 fs-14">Bugünkü siparişlerden elde edilen toplam ciro</p>
                        <span class="d-flex align-content-center gap-1 bg-success bg-opacity-10 border border-success" style="padding: 3px 5px;">
                            <i class="material-symbols-outlined fs-14 text-success">trending_up</i>
                            <span class="lh-1 fs-14 text-success"></span>
                        </span>
                    </div>
                </div>

            </div>

            <!-- Sipariş Özeti -->
            <div class="col-md-6 col-xxxl-6 col-xxl-12">
                <div class="bg-primary-50 p-20 border rounded-10 border-primary-50 mb-4">
                    <h3 class="text-white mb-12">Sipariş Özeti</h3>
                    <div class="d-flex flex-wrap gap-2 justify-content-between mb-14">
                        <div>
                            <span class="fs-14 text-white mb-1 d-block">Toplam Sipariş</span>
                            <h2 class="fs-20 fw-medium lh-1 text-white mb-0" id="totalOrderCountOverview">
                                @Model.TotalOrderCount
                            </h2>
                        </div>
                        <div>
                            <span class="fs-14 text-white mb-1 d-block">Aylık Sipariş</span>
                            <h2 class="fs-20 fw-medium lh-1 text-white mb-0" id="monthlyOrderCount">
                                @Model.MonthlyOrderCount
                            </h2>
                        </div>
                        <div>
                            <span class="fs-14 text-white mb-1 d-block">Bugünkü Sipariş</span>
                            <h2 class="fs-20 fw-medium lh-1 text-white mb-0" id="todayOrderCount">
                                @Model.TodayOrderCount
                            </h2>
                        </div>
                    </div>
                    <div class="progress rounded-0 mb-6" role="progressbar" aria-valuenow="80" aria-valuemin="0" aria-valuemax="100" style="height: 3px; background-color: #6258cc;">
                        <div class="progress-bar rounded-0 bg-white" style="width: 80%; height: 3px;"></div>
                    </div>
                    <span class="fs-14 text-white d-block" style="margin-bottom: -6px;">Geçen aya göre %20 artış</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- KAR, GÜNLÜK ORTALAMA, EN ÇOK SATAN ÜRÜN, YENİ MİSAFİRLER -->
<div class="row">
    <div class="col-xxl-6 col-xxxl-12">
        <div class="row">
            <!-- Kâr -->
            <div class="col-lg-6">
                <div class="card bg-white p-20 rounded-10 border border-white mb-4">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 mb-20">
                        <h3>Kâr Marjı</h3>

                        <div class="dropdown select-dropdown without-border">
                            <button class="dropdown-toggle bg-transparent text-secondary fs-15" data-bs-toggle="dropdown" aria-expanded="false">
                                Son Ay
                            </button>

                            <ul class="dropdown-menu dropdown-menu-end bg-white border-0 box-shadow rounded-10" data-simplebar>
                                <li><button class="dropdown-item text-secondary">Son Gün</button></li>
                                <li><button class="dropdown-item text-secondary">Son Hafta</button></li>
                                <li><button class="dropdown-item text-secondary">Son Ay</button></li>
                                <li><button class="dropdown-item text-secondary">Son Yıl</button></li>
                            </ul>
                        </div>
                    </div>

                    <h2 class="lh-1 fs-26 fw-medium" style="margin-bottom: -10px;">₺359K</h2>

                    <div id="profit_chart" style="margin-bottom: -17px;"></div>
                </div>
            </div>

            <!-- Günlük Ortalama Sipariş -->
            <div class="col-lg-6">
                <div class="card bg-white p-20 rounded-10 border border-white mb-4">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 mb-20">
                        <h3>Günlük Ortalama Ciro</h3>

                        <span class="d-flex align-content-center gap-1 bg-success bg-opacity-10 border border-success" style="padding: 3px 5px;">
                            <i class="material-symbols-outlined fs-14 text-success">trending_up</i>
                            <span class="lh-1 fs-14 text-success">+5,25%</span>
                        </span>
                    </div>

                    <h2 class="lh-1 fs-26 fw-medium mb-0">₺5.000+</h2>

                    <div id="average_daily_sales_chart" style="margin-bottom: -17px;"></div>
                </div>
            </div>

            <!-- Bu Ay En Çok Satan Ürün -->
            <div class="col-md-6">
                <div class="card p-20 bg-light-40 rounded-10 border-light-40 mb-4 position-relative z-1">
                    <h3 class="mb-20">Bu Ay En Çok Satan Ürün</h3>
                    <h3 class="mb-12 text-primary-50">Terabithia Burger Menü</h3>
                    <h2 class="lh-1 fs-26 fw-medium">
                        ₺3.500
                        <span class="fs-16 text-body">(Toplam Satış)</span>
                    </h2>
                    <a href="#" class="fw-medium fs-16 text-secondary hover-text d-inline-block" style="margin-top: 84px;">Detayı Gör</a>
                    <img src="~/teraQR/assets/images/man.png" class="position-absolute bottom-0 end-0 pe-3" alt="chef">
                </div>
            </div>

            <!-- Bu Ay Yeni Müşteriler / Rezervasyon -->
            <div class="col-md-6">
                <div class="card p-20 bg-white rounded-10 border border-white mb-4 position-relative z-1">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 mb-20">
                        <h3>Bu Ay Yeni Misafirler</h3>

                        <span class="d-flex align-content-center gap-1 bg-success bg-opacity-10 border border-success" style="padding: 3px 5px;">
                            <i class="material-symbols-outlined fs-14 text-success">trending_up</i>
                            <span class="lh-1 fs-14 text-success">+2,75%</span>
                        </span>
                    </div>
                    <h2 class="lh-1 fs-26 fw-medium">2.537</h2>
                    <div style="margin-top: 55px;">
                        <span class="fs-16 text-body d-block mb-10">Bugün rezervasyon oluşturanlar</span>
                        <ul class="p-0 mb-0 list-unstyled d-flex last-child-none global-right-list">
                            <li style="margin-right: -20px;">
                                <img src="~/teraQR/assets/images/user12.jpg" class="border border-3 border-white rounded-circle" style="width: 52px; height: 52px;" alt="user12">
                            </li>
                            <li style="margin-right: -20px;">
                                <img src="~/teraQR/assets/images/user13.jpg" class="border border-3 border-white rounded-circle" style="width: 52px; height: 52px;" alt="user13">
                            </li>
                            <li style="margin-right: -20px;">
                                <img src="~/teraQR/assets/images/user14.jpg" class="border border-3 border-white rounded-circle" style="width: 52px; height: 52px;" alt="user14">
                            </li>
                            <li style="margin-right: -20px;">
                                <img src="~/teraQR/assets/images/user15.jpg" class="border border-3 border-white rounded-circle" style="width: 52px; height: 52px;" alt="user15">
                            </li>
                            <li style="margin-right: -20px;">
                                <img src="~/teraQR/assets/images/user16.jpg" class="border border-3 border-white rounded-circle" style="width: 52px; height: 52px;" alt="user16">
                            </li>
                            <li class="border border-3 border-white rounded-circle bg-primary text-center" style="margin-right: -20px; width: 52px; height: 52px; line-height: 49px;">
                                <span class="text-white fs-16 fw-medium">+27</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- EN ÇOK SATILAN ÜRÜNLER -->
    <div class="col-xxl-6 col-xxxl-12">
        <div class="card bg-white p-20 rounded-10 border border-white mb-4">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 mb-20">
                <h3>En Çok Satılan Ürünler</h3>

                <div class="dropdown select-dropdown without-border">
                    <button class="dropdown-toggle bg-transparent text-secondary fs-15" data-bs-toggle="dropdown" aria-expanded="false">
                        Bu Hafta
                    </button>

                    <ul class="dropdown-menu dropdown-menu-end bg-white border-0 box-shadow rounded-10" data-simplebar>
                        <li><button class="dropdown-item text-secondary">Bugün</button></li>
                        <li><button class="dropdown-item text-secondary">Bu Hafta</button></li>
                        <li><button class="dropdown-item text-secondary">Bu Ay</button></li>
                        <li><button class="dropdown-item text-secondary">Bu Yıl</button></li>
                    </ul>
                </div>
            </div>

            

            <div class="default-table-area without-header table-top-selling-products">
                <div class="table-responsive">
                    <table class="table align-middle">
                        <tbody>
                            @if (Model.TopProducts != null && Model.TopProducts.Any())
                            {
                                var index = 1;
                                foreach (var item in Model.TopProducts)
                                {
                                    <tr>
                                        <td class="text-body fw-medium">
                                            @index.ToString("00").
                                        </td>
                                        <td class="ps-0">
                                            <div class="d-flex align-items-center text-decoration-none">
                                                <div class="flex-shrink-0">
                                                    <img src="@item.ImageUrl"
                                                         class="rounded-circle"
                                                         style="width: 50px; height: 50px;"
                                                         alt="@item.ProductName" />
                                                </div>
                                                <div class="flex-grow-1 ms-12">
                                                    <h3 class="fw-normal hover-text">@item.ProductName</h3>
                                                    <span class="fs-14 text-body fw-normal">
                                                        @item.TotalQuantity adet satıldı
                                                    </span>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="text-body">
                                            Toplam Tutar:
                                            @item.TotalAmount.ToString("C0", new System.Globalization.CultureInfo("tr-TR"))
                                        </td>
                                    </tr>

                                    index++;
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="3" class="text-center text-muted">
                                        Henüz istatistik oluşturacak kadar satış verisi bulunmuyor.
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- SİPARİŞ ÖZETİ, EN ÇOK SİPARİŞ VERENLER -->
<div class="row">
    <!-- Sipariş Durum Özeti -->
    <div class="col-lg-6 col-xxl-4 col-xxxl-6 mb-4">
        <div class="card bg-white p-20 rounded-10 border border-white">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 mb-20">
                <h3>Sipariş Durum Özeti</h3>

                <div class="dropdown select-dropdown without-border">
                    <button class="dropdown-toggle bg-transparent text-secondary fs-15" data-bs-toggle="dropdown" aria-expanded="false">
                        Bu Hafta
                    </button>

                    <ul class="dropdown-menu dropdown-menu-end bg-white border-0 box-shadow rounded-10" data-simplebar>
                        <li><button class="dropdown-item text-secondary">Bugün</button></li>
                        <li><button class="dropdown-item text-secondary">Bu Hafta</button></li>
                        <li><button class="dropdown-item text-secondary">Bu Ay</button></li>
                        <li><button class="dropdown-item text-secondary">Bu Yıl</button></li>
                    </ul>
                </div>
            </div>

            <div class="d-flex justify-content-between align-items-center mb-20">
                <span class="fs-15 text-secondary">Tamamlanan %60</span>
                <span class="fs-15 text-secondary">Yeni Sipariş %30</span>
                <span class="fs-15 text-secondary">Hazırlanıyor %10</span>
            </div>

            <div id="order_summary_chart"></div>
        </div>
    </div>

    <!-- En Çok Sipariş Veren Müşteriler -->
    <div class="col-lg-6 col-xxl-4 col-xxxl-6">
        <div class="card bg-white p-20 rounded-10 border border-white mb-4">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 mb-20">
                <h3>En Çok Sipariş Veren Müşteriler</h3>

                <div class="dropdown select-dropdown without-border">
                    <button class="dropdown-toggle bg-transparent text-secondary fs-15" data-bs-toggle="dropdown" aria-expanded="false">
                        Bu Hafta
                    </button>

                    <ul class="dropdown-menu dropdown-menu-end bg-white border-0 box-shadow rounded-10" data-simplebar>
                        <li><button class="dropdown-item text-secondary">Bugün</button></li>
                        <li><button class="dropdown-item text-secondary">Bu Hafta</button></li>
                        <li><button class="dropdown-item text-secondary">Bu Ay</button></li>
                        <li><button class="dropdown-item text-secondary">Bu Yıl</button></li>
                    </ul>
                </div>
            </div>

            <div class="default-table-area without-header table-top-sellers">
                <div class="table-responsive">
                    <table class="table align-middle">
                        <tbody>
                            <tr>
                                <td class="text-body fw-medium">01.</td>
                                <td class="ps-0">
                                    <div class="d-flex align-items-center text-decoration-none">
                                        <div class="flex-shrink-0">
                                            <img src="~/teraQR/assets/images/user6.jpg" class="rounded-circle" style="width: 50px; height: 50px;" alt="user6">
                                        </div>
                                        <div class="flex-grow-1 ms-12">
                                            <h3 class="fw-normal">Mark Stjohn</h3>
                                            <span class="fs-14 text-body fw-normal">Toplam 54 sipariş</span>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <ul class="p-0 mb-0 list-unstyled d-flex align-items-center justify-content-end" style="gap: 2px;">
                                        <li><i class="ri-star-fill text-warning fs-16"></i></li>
                                        <li><i class="ri-star-fill text-warning fs-16"></i></li>
                                        <li><i class="ri-star-fill text-warning fs-16"></i></li>
                                        <li><i class="ri-star-fill text-warning fs-16"></i></li>
                                        <li><i class="ri-star-fill text-warning fs-16"></i></li>
                                        <li><span class="fs-14 text-body fw-normal">(5)</span></li>
                                    </ul>
                                </td>
                            </tr>
                            <tr>
                                <td class="text-body fw-medium">02.</td>
                                <td class="ps-0">
                                    <div class="d-flex align-items-center text-decoration-none">
                                        <div class="flex-shrink-0">
                                            <img src="~/teraQR/assets/images/user7.jpg" class="rounded-circle" style="width: 50px; height: 50px;" alt="user7">
                                        </div>
                                        <div class="flex-grow-1 ms-12">
                                            <h3 class="fw-normal">Joan Stanley</h3>
                                            <span class="fs-14 text-body fw-normal">Toplam 47 sipariş</span>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <ul class="p-0 mb-0 list-unstyled d-flex align-items-center justify-content-end" style="gap: 2px;">
                                        <li><i class="ri-star-fill text-warning fs-16"></i></li>
                                        <li><i class="ri-star-fill text-warning fs-16"></i></li>
                                        <li><i class="ri-star-fill text-warning fs-16"></i></li>
                                        <li><i class="ri-star-fill text-warning fs-16"></i></li>
                                        <li><i class="ri-star-half-fill text-warning fs-16"></i></li>
                                        <li><span class="fs-14 text-body fw-normal">(4,5)</span></li>
                                    </ul>
                                </td>
                            </tr>
                            <!-- Diğer satırlar aynı mantıkla devam ediyor -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Paket Servis Bölgeleri + Gelir Grafiği -->
    <div class="col-lg-12 col-xxl-4 col-xxxl-12">
        <div class="row">
            <!-- Paket Servis Bölgeleri -->
            <div class="col-xxl-12 col-lg-6 col-xxxl-6">
                <div class="card bg-white p-20 rounded-10 border border-white mb-4">
                    <h3 class="mb-20">En Fazla Sipariş Gelen Bölgeler</h3>
                    <div class="row align-items-center">
                        <div class="col-lg-7 col-sm-6">
                            <div class="text-center">
                                <div id="sales_by_locations_map"></div>
                            </div>
                        </div>
                        <div class="col-lg-5 col-sm-6">
                            <ul class="p-0 mb-0 list-unstyled last-child-none mt-4 mt-sm-0">
                                <li class="d-flex align-items-center gap-2 mb-9">
                                    <img src="~/teraQR/assets/images/turkey.png" class="rounded-circle" style="width: 20px; height: 20px;" alt="istanbul">
                                    <span class="fs-15">İstanbul <span class="text-secondary">85%</span></span>
                                </li>
                                <li class="d-flex align-items-center gap-2 mb-9">
                                    <img src="~/teraQR/assets/images/turkey.png" class="rounded-circle" style="width: 20px; height: 20px;" alt="ankara">
                                    <span class="fs-15">Ankara <span class="text-secondary">60%</span></span>
                                </li>
                                <li class="d-flex align-items-center gap-2 mb-9">
                                    <img src="~/teraQR/assets/images/turkey.png" class="rounded-circle" style="width: 20px; height: 20px;" alt="izmir">
                                    <span class="fs-15">İzmir <span class="text-secondary">55%</span></span>
                                </li>
                                <!-- İstersen burayı ilçeler / semtler olarak da değiştirebiliriz -->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gelir Grafiği -->
            <div class="col-xxl-12 col-lg-6 col-xxxl-6">
                <div class="card bg-white p-20 rounded-10 border border border-white mb-4">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 mb-0">
                        <h3>Gelir Grafiği</h3>

                        <div class="dropdown select-dropdown without-border">
                            <button class="dropdown-toggle bg-transparent text-secondary fs-15" data-bs-toggle="dropdown" aria-expanded="false">
                                Bu Hafta
                            </button>

                            <ul class="dropdown-menu dropdown-menu-end bg-white border-0 box-shadow rounded-10" data-simplebar>
                                <li><button class="dropdown-item text-secondary">Bugün</button></li>
                                <li><button class="dropdown-item text-secondary">Bu Hafta</button></li>
                                <li><button class="dropdown-item text-secondary">Bu Ay</button></li>
                                <li><button class="dropdown-item text-secondary">Bu Yıl</button></li>
                            </ul>
                        </div>
                    </div>

                    <div id="revenue_chart" style="margin-bottom: -17px;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SON SİPARİŞLER + İŞLEM GEÇMİŞİ -->
<div class="row">
    <!-- Son Siparişler -->
    <div class="col-xxl-8 col-xxxxl-12">
        <div class="card bg-white rounded-10 border border-white mb-4">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 p-20">
                <h3>Son Siparişler</h3>

                <div class="d-flex align-items-center">
                    <div class="dropdown select-dropdown without-border">
                        <button class="dropdown-toggle bg-transparent text-secondary fs-15" data-bs-toggle="dropdown" aria-expanded="false">
                            Tümü
                        </button>

                        <ul class="dropdown-menu dropdown-menu-end bg-white border-0 box-shadow rounded-10" data-simplebar>
                            <li><button class="dropdown-item text-secondary">Serviste</button></li>
                            <li><button class="dropdown-item text-secondary">Hazırlanıyor</button></li>
                            <li><button class="dropdown-item text-secondary">Tamamlandı</button></li>
                            <li><button class="dropdown-item text-secondary">İptal Edildi</button></li>
                        </ul>
                    </div>

                    <form class="table-src-form position-relative">
                        <input type="text" class="form-control" placeholder="Sipariş veya müşteri ara...">
                        <div class="src-btn position-absolute top-50 start-0 translate-middle-y bg-transparent p-0 border-0">
                            <span class="material-symbols-outlined">search</span>
                        </div>
                    </form>
                </div>
            </div>

            <div class="default-table-area mx-minus-1 table-recent-orders">
                <div class="table-responsive">
                    <table class="table align-middle">
                        <thead>
                            <tr>
                                <th scope="col" class="fw-medium">Sipariş No</th>
                                <th scope="col" class="fw-medium">Masa / Müşteri</th>
                                <th scope="col" class="fw-medium">Tarih</th>
                                <th scope="col" class="fw-medium">Tutar</th>
                                <th scope="col" class="fw-medium">Kâr</th>
                                <th scope="col" class="fw-medium">Durum</th>
                                <th scope="col" class="fw-medium">İşlem</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.RecentOrders != null && Model.RecentOrders.Any())
                            {
                                foreach (var order in Model.RecentOrders)
                                {
                                    <tr>
                                        <td class="text-body">#@order.OrderID</td>
                                        <td>
                                            <div class="d-flex align-items-center text-decoration-none">
                                                <div class="flex-grow-1 ms-12">
                                                    <h3 class="fw-medium hover-text mb-0 fs-16">
                                                        @order.CustomerName
                                                    </h3>
                                                    <span class="fs-14 text-body">
                                                        @order.TableName
                                                    </span>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="text-body">
                                            @order.CreatedDate.ToString("dd MMM yyyy HH:mm")
                                        </td>
                                        <td class="text-body">
                                            @order.TotalPrice.ToString("C0", new System.Globalization.CultureInfo("tr-TR"))
                                        </td>
                                        <td class="text-body">
                                            @order.Profit.ToString("C0", new System.Globalization.CultureInfo("tr-TR"))
                                        </td>
                                        <td>
                                            @{
                                                string badgeText;
                                                string badgeClass;

                                                switch (order.StatusText)
                                                {
                                                    case "1":
                                                        badgeText = "Hazırlanıyor";
                                                        badgeClass = "text-warning bg-warning bg-opacity-10";
                                                        break;
                                                    case "2":
                                                        badgeText = "Tamamlandı";
                                                        badgeClass = "text-success bg-success bg-opacity-10";
                                                        break;
                                                    default:
                                                        badgeText = "Bekliyor";
                                                        badgeClass = "text-primary bg-primary bg-opacity-10";
                                                        break;
                                                }
                                            }
                                            <span class="@badgeClass fs-15 fw-normal d-inline-block default-badge">
                                                @badgeText
                                            </span>
                                        </td>
                                        <td>
                                            <div class="d-flex justify-content-end" style="gap: 12px;">
                                                <button class="bg-transparent p-0 border-0" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Detay">
                                                    <i class="material-symbols-outlined fs-16 fw-normal text-primary">visibility</i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="7" class="text-center text-muted">
                                        Son sipariş kaydı bulunamadı.
                                    </td>
                                </tr>
                            }
                        </tbody>

                    </table>
                </div>

                <div class="d-flex justify-content-center justify-content-sm-between align-items-center text-center flex-wrap gap-2 showing-wrap pt-15 p-20">
                    <span class="fs-15">Toplam 50 kayıttan 1–5 arası gösteriliyor</span>

                    <nav class="custom-pagination" aria-label="Page navigation example">
                        <ul class="pagination mb-0 justify-content-center">
                            <li class="page-item">
                                <button class="page-link icon" aria-label="Previous">
                                    <i class="material-symbols-outlined">west</i>
                                </button>
                            </li>
                            <li class="page-item"><button class="page-link active">1</button></li>
                            <li class="page-item"><button class="page-link">2</button></li>
                            <li class="page-item"><button class="page-link">3</button></li>
                            <li class="page-item">
                                <button class="page-link icon" aria-label="Next">
                                    <i class="material-symbols-outlined">east</i>
                                </button>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- İşlem Geçmişi -->
    <div class="col-xxl-4 col-xxxxl-12">
        <div class="card bg-white p-20 rounded-10 border border-white mb-4">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 mb-20">
                <h3>Ödeme / İşlem Geçmişi</h3>

                <div class="dropdown select-dropdown without-border">
                    <button class="dropdown-toggle bg-transparent text-secondary fs-15" data-bs-toggle="dropdown" aria-expanded="false">
                        Son Ay
                    </button>

                    <ul class="dropdown-menu dropdown-menu-end bg-white border-0 box-shadow rounded-10" data-simplebar>
                        <li><button class="dropdown-item text-secondary">Son Gün</button></li>
                        <li><button class="dropdown-item text-secondary">Son Hafta</button></li>
                        <li><button class="dropdown-item text-secondary">Son Ay</button></li>
                        <li><button class="dropdown-item text-secondary">Son Yıl</button></li>
                    </ul>
                </div>
            </div>

            <div class="default-table-area without-header table-transactions-history">
                <div class="table-responsive">
                    <table class="table align-middle">
                        <tbody>
                            <tr>
                                <td class="ps-0">
                                    <div class="d-flex align-items-center text-decoration-none">
                                        <div class="flex-shrink-0">
                                            <div class="text-primary text-center rounded-circle" style="width: 50px; height: 50px; line-height: 62px; background-color: #dbeafd;">
                                                <i class="material-symbols-outlined fs-24">settings_backup_restore</i>
                                            </div>
                                        </div>
                                        <div class="flex-grow-1 ms-15">
                                            <h3 class="fw-normal">İade İşlemi</h3>
                                            <span class="fs-14 text-body fw-normal">15 Kas 2025 - 11:40</span>
                                        </div>
                                    </div>
                                </td>
                                <td class="fw-normal text-success fs-16">+₺995</td>
                            </tr>
                            <tr>
                                <td class="ps-0">
                                    <div class="d-flex align-items-center text-decoration-none">
                                        <div class="flex-shrink-0">
                                            <div class="text-danger text-center rounded-circle" style="width: 50px; height: 50px; line-height: 62px; background-color: #fce4e2;">
                                                <i class="material-symbols-outlined fs-24">account_balance</i>
                                            </div>
                                        </div>
                                        <div class="flex-grow-1 ms-15">
                                            <h3 class="fw-normal">Banka Havalesi</h3>
                                            <span class="fs-14 text-body fw-normal">15 Kas 2025 - 08:20</span>
                                        </div>
                                    </div>
                                </td>
                                <td class="fw-normal text-danger fs-16">-₺1.550</td>
                            </tr>
                            <!-- Diğer satırlar aynı mantıkla devam ediyor -->
                        </tbody>
                    </table>
                </div>
                <div class="d-flex justify-content-center justify-content-sm-between align-items-center text-center flex-wrap gap-2 showing-wrap pt-15">
                    <span class="fs-15">Toplam 50 kayıttan 1–5 arası gösteriliyor</span>

                    <nav class="custom-pagination" aria-label="Page navigation example">
                        <ul class="pagination mb-0 justify-content-center">
                            <li class="page-item">
                                <button class="page-link icon" aria-label="Previous">
                                    <i class="material-symbols-outlined">west</i>
                                </button>
                            </li>
                            <li class="page-item"><button class="page-link active">1</button></li>
                            <li class="page-item"><button class="page-link">2</button></li>
                            <li class="page-item"><button class="page-link">3</button></li>
                            <li class="page-item">
                                <button class="page-link icon" aria-label="Next">
                                    <i class="material-symbols-outlined">east</i>
                                </button>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>
@section Scripts {
    <!-- SignalR JS (CDN üzerinden) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"
            crossorigin="anonymous"></script>

    <script>
        // WebAPI adresin: https://localhost:7074
        // Hub endpoint: /signalRHub (Program.cs'te MapHub ile verdik)
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("https://localhost:7074/signalRHub")
            .withAutomaticReconnect()
            .build();

        // Yardımcı: TRY format
        function formatCurrency(value) {
            return new Intl.NumberFormat("tr-TR", {
                style: "currency",
                currency: "TRY",
                maximumFractionDigits: 0
            }).format(value ?? 0);
        }

        // Yardımcı: element text güncelle
        function setText(id, text) {
            const el = document.getElementById(id);
            if (el) el.textContent = text;
        }

        // Backend'den dashboard özeti geldiğinde tetiklenecek kısım
        connection.on("ReceiveDashboardSummary", function (data) {
            console.log("Dashboard summary (SignalR):", data);

            // 🟢 Kartlardaki sayıları güncelle
            setText("totalOrderCount", data.totalOrderCount);
            setText("totalGuestCount", data.totalGuestCount);
            setText("todayRevenue", formatCurrency(data.todayRevenue));
            setText("totalOrderCountOverview", data.totalOrderCount);
            setText("monthlyOrderCount", data.monthlyOrderCount);
            setText("todayOrderCount", data.todayOrderCount);

            // 🟠 En çok satılan ürünler tablosu
            const tbodyTop = document.querySelector(".table-top-selling-products tbody");
            if (tbodyTop && Array.isArray(data.topProducts)) {
                if (data.topProducts.length === 0) {
                    tbodyTop.innerHTML = `
                        <tr>
                            <td colspan="3" class="text-center text-muted">
                                Henüz istatistik oluşturacak kadar satış verisi bulunmuyor.
                            </td>
                        </tr>`;
                } else {
                    const rows = data.topProducts.map((p, idx) => `
                        <tr>
                            <td class="text-body fw-medium">
                                ${(idx + 1).toString().padStart(2, "0")}.
                            </td>
                            <td class="ps-0">
                                <div class="d-flex align-items-center text-decoration-none">
                                    <div class="flex-shrink-0">
                                        <img src="${p.imageUrl}"
                                             class="rounded-circle"
                                             style="width: 50px; height: 50px;"
                                             alt="${p.productName}" />
                                    </div>
                                    <div class="flex-grow-1 ms-12">
                                        <h3 class="fw-normal hover-text">${p.productName}</h3>
                                        <span class="fs-14 text-body fw-normal">
                                            ${p.totalQuantity} adet satıldı
                                        </span>
                                    </div>
                                </div>
                            </td>
                            <td class="text-body">
                                Toplam Tutar:
                                ${formatCurrency(p.totalAmount)}
                            </td>
                        </tr>
                    `).join("");

                    tbodyTop.innerHTML = rows;
                }
            }

            // 🔵 Son siparişler tablosu
            const tbodyRecent = document.querySelector(".table-recent-orders tbody");
            if (tbodyRecent && Array.isArray(data.recentOrders)) {
                if (data.recentOrders.length === 0) {
                    tbodyRecent.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center text-muted">
                                Son sipariş kaydı bulunamadı.
                            </td>
                        </tr>`;
                } else {
                    const rows = data.recentOrders.map(order => {
                        const created = new Date(order.createdDate);
                        const dateStr = created.toLocaleString("tr-TR", {
                            year: "numeric",
                            month: "short",
                            day: "2-digit",
                            hour: "2-digit",
                            minute: "2-digit"
                        });

                        let badgeText;
                        let badgeClass;

                        switch (order.statusText) {
                            case "1":
                                badgeText = "Hazırlanıyor";
                                badgeClass = "text-warning bg-warning bg-opacity-10";
                                break;
                            case "2":
                                badgeText = "Tamamlandı";
                                badgeClass = "text-success bg-success bg-opacity-10";
                                break;
                            default:
                                badgeText = "Bekliyor";
                                badgeClass = "text-primary bg-primary bg-opacity-10";
                                break;
                        }

                        return `
                            <tr>
                                <td class="text-body">#${order.orderID}</td>
                                <td>
                                    <div class="d-flex align-items-center text-decoration-none">
                                        <div class="flex-grow-1 ms-12">
                                            <h3 class="fw-medium hover-text mb-0 fs-16">
                                                ${order.customerName ?? ""}
                                            </h3>
                                            <span class="fs-14 text-body">
                                                ${order.tableName ?? ""}
                                            </span>
                                        </div>
                                    </div>
                                </td>
                                <td class="text-body">
                                    ${dateStr}
                                </td>
                                <td class="text-body">
                                    ${formatCurrency(order.totalPrice)}
                                </td>
                                <td class="text-body">
                                    ${formatCurrency(order.profit)}
                                </td>
                                <td>
                                    <span class="${badgeClass} fs-15 fw-normal d-inline-block default-badge">
                                        ${badgeText}
                                    </span>
                                </td>
                                <td>
                                    <div class="d-flex justify-content-end" style="gap: 12px;">
                                        <button class="bg-transparent p-0 border-0"
                                                data-bs-toggle="tooltip"
                                                data-bs-placement="top"
                                                data-bs-title="Detay">
                                            <i class="material-symbols-outlined fs-16 fw-normal text-primary">visibility</i>
                                        </button>
                                    </div>
                                </td>
                            </tr>`;
                    }).join("");

                    tbodyRecent.innerHTML = rows;
                }
            }
        });

        // Bağlantıyı başlat
        async function startConnection() {
            try {
                await connection.start();
                console.log("Dashboard SignalR connected");

                // İstersen ekstra tetikleme:
                // await connection.invoke("SendDashboardSummary");
            } catch (err) {
                console.error("SignalR connection error:", err);
                setTimeout(startConnection, 5000);
            }
        }

        connection.onclose(startConnection);

        document.addEventListener("DOMContentLoaded", function () {
            startConnection();
        });
    </script>
}
