@using Asp.NetCore10._0_QR_Restaurant_Order.WebUI.DTOs.DiscountDTOs
@model UpdateDiscountDTO

@{
    ViewData["Title"] = "İndirim Güncelle";
    Layout = "~/Views/AdminLayout/Index.cshtml";
    ViewData["Breadcrumb"] = new List<(string Text, string Url)>
    {
        ("İndirimler", "/Discount/DiscountList/"),
        ("İndirim Güncelle", "")
    };
}

<div class="card bg-white p-20 rounded-10 border border-white mb-4">
    <form method="post" asp-action="UpdateDiscount" enctype="multipart/form-data">
        <div class="row">

            @* Update için ID + eski görsel URL mutlaka taşınmalı *@
            <input type="hidden" asp-for="DiscountID" />
            <input type="hidden" asp-for="DiscountImageURL" />

            <!-- SOL TARAF -->
            <div class="col-lg-8">
                <h3 class="mb-20">İndirim Güncelle</h3>

                <div class="row">

                    <div class="col-lg-12">
                        <div class="mb-20">
                            <label class="label fs-16 mb-2">Başlık</label>
                            <div class="form-floating">
                                <input asp-for="DiscountTitle" type="text" class="form-control" id="floatingTitle2" placeholder="Başlık">
                                <label for="floatingTitle2">Başlık</label>
                            </div>
                            <span class="text-danger" asp-validation-for="DiscountTitle"></span>
                        </div>
                    </div>

                    <div class="col-lg-6">
                        <div class="mb-20">
                            <label class="label fs-16 mb-2">İndirim Oranı</label>
                            <div class="form-floating">
                                <input asp-for="DiscountAmount" type="number" step="0.01" class="form-control" id="floatingAmount2" placeholder="İndirim">
                                <label for="floatingAmount2">İndirim</label>
                            </div>
                            <span class="text-danger" asp-validation-for="DiscountAmount"></span>
                        </div>
                    </div>

                    <div class="col-lg-6">
                        <div class="mb-20">
                            <label class="label fs-16 mb-2">Durum</label>
                            <div class="form-floating">
                                <select asp-for="DiscountStatus" class="form-select form-control" id="floatingStatus2">
                                    <option value="true">Aktif</option>
                                    <option value="false">Pasif</option>
                                </select>
                                <label for="floatingStatus2">Durum</label>
                            </div>
                            <span class="text-danger" asp-validation-for="DiscountStatus"></span>
                        </div>
                    </div>

                    <!-- Görsel (Drag & Drop) -->
                    <div class="col-lg-12">
                        <div class="form-group mb-4 only-file-upload" id="file-upload2">
                            <label class="label fs-16 mb-2 text-secondary">İndirim Görselini Güncelle</label>

                            <div class="form-control h-100 text-center position-relative p-4 p-lg-5" id="dropArea2" style="cursor:pointer;">
                                <div class="product-upload">
                                    <label class="file-upload mb-0">
                                        <i class="ri-folder-image-line bg-primary bg-opacity-10 p-2 rounded-1 text-primary"></i>
                                        <span class="d-block text-body fs-14">
                                            Görseli sürükleyip bırak veya
                                            <span class="text-primary text-decoration-underline">Gözat</span>
                                        </span>
                                        <small class="text-muted d-block mt-1">JPG, PNG, WEBP önerilir</small>
                                    </label>

                                    <label class="position-absolute top-0 bottom-0 start-0 end-0 cursor">
                                        <input asp-for="DiscountImageFile" class="form__file bottom-0"
                                               id="upload-files2" type="file" accept="image/*">
                                    </label>
                                </div>
                            </div>

                            <div class="mt-2 d-flex align-items-center gap-2">
                                <img id="previewImg2"
                                     src="@(string.IsNullOrWhiteSpace(Model.DiscountImageURL) ? "" : Model.DiscountImageURL)"
                                     alt=""
                                     style="width:48px;height:48px;object-fit:cover;@(string.IsNullOrWhiteSpace(Model.DiscountImageURL) ? "display:none;" : "display:block;")border-radius:8px;" />
                                <span id="fileName2" class="text-body fs-14"></span>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-12">
                        <div class="form-group mb-20">
                            <label class="label fs-16 mb-2">Açıklama</label>
                            <div class="form-floating">
                                <textarea asp-for="DiscountDescription"
                                          class="form-control"
                                          id="floatingDesc2"
                                          placeholder="Açıklama"
                                          style="height: 163px; border-color: #D5D9E2;"></textarea>
                                <label for="floatingDesc2">Açıklama</label>
                            </div>
                            <span class="text-danger" asp-validation-for="DiscountDescription"></span>
                        </div>
                    </div>

                    <div class="col-lg-12">
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary fw-normal text-white">Güncelle</button>
                            <a href="/Discount/DiscountList/" class="btn btn-danger fw-normal text-white">İptal</a>
                        </div>
                    </div>

                </div>
            </div>

            <!-- SAĞ TARAF -->
            <div class="col-lg-4">
                <h3 class="mb-20">Önizleme</h3>

                <div class="card p-3 border">
                    <div class="d-flex align-items-center gap-3">
                        <img id="previewImgSide2"
                             src="@(string.IsNullOrWhiteSpace(Model.DiscountImageURL) ? "" : Model.DiscountImageURL)"
                             alt=""
                             style="width:72px;height:72px;object-fit:cover;@(string.IsNullOrWhiteSpace(Model.DiscountImageURL) ? "display:none;" : "display:block;")border-radius:12px;" />
                        <div class="flex-grow-1">
                            <div class="fw-semibold" id="titlePreview2">@(!string.IsNullOrWhiteSpace(Model.DiscountTitle) ? Model.DiscountTitle : "Başlık")</div>
                            <small class="text-muted d-block" id="amountPreview2">İndirim: %@Model.DiscountAmount</small>
                            <small class="text-muted d-block" id="statusPreview2">Durum: @(Model.DiscountStatus ? "Aktif" : "Pasif")</small>
                        </div>
                    </div>
                    <hr class="my-3" />
                    <div class="text-muted" style="max-height: 120px; overflow:auto;" id="descPreview2">
                        @(!string.IsNullOrWhiteSpace(Model.DiscountDescription) ? Model.DiscountDescription : "Açıklama")
                    </div>
                </div>
            </div>

        </div>
    </form>
</div>

<script>
    // Drag & Drop + preview
    const dropArea2 = document.getElementById("dropArea2");
    const fileInput2 = document.getElementById("upload-files2");
    const fileName2 = document.getElementById("fileName2");
    const previewImg2 = document.getElementById("previewImg2");
    const previewImgSide2 = document.getElementById("previewImgSide2");

    // canlı önizleme
    const titleInput2 = document.getElementById("floatingTitle2");
    const amountInput2 = document.getElementById("floatingAmount2");
    const statusSelect2 = document.getElementById("floatingStatus2");
    const descInput2 = document.getElementById("floatingDesc2");

    const titlePreview2 = document.getElementById("titlePreview2");
    const amountPreview2 = document.getElementById("amountPreview2");
    const statusPreview2 = document.getElementById("statusPreview2");
    const descPreview2 = document.getElementById("descPreview2");

    function showPreview2(file) {
        if (!file) return;

        fileName2.textContent = file.name;

        const url = URL.createObjectURL(file);

        previewImg2.src = url;
        previewImg2.style.display = "block";

        previewImgSide2.src = url;
        previewImgSide2.style.display = "block";
    }

    fileInput2.addEventListener("change", () => {
        const file = fileInput2.files && fileInput2.files[0];
        showPreview2(file);
    });

    ["dragenter", "dragover"].forEach(evt => {
        dropArea2.addEventListener(evt, e => {
            e.preventDefault();
            e.stopPropagation();
            dropArea2.classList.add("border", "border-primary");
        });
    });

    ["dragleave", "drop"].forEach(evt => {
        dropArea2.addEventListener(evt, e => {
            e.preventDefault();
            e.stopPropagation();
            dropArea2.classList.remove("border", "border-primary");
        });
    });

    dropArea2.addEventListener("drop", e => {
        const files = e.dataTransfer.files;
        if (!files || files.length === 0) return;

        fileInput2.files = files;
        showPreview2(files[0]);
    });

    // sağ kart canlı önizleme
    titleInput2.addEventListener("input", () => {
        titlePreview2.textContent = titleInput2.value?.trim() ? titleInput2.value : "Başlık";
    });

    amountInput2.addEventListener("input", () => {
        const val = amountInput2.value?.trim() ? amountInput2.value : "0";
        amountPreview2.textContent = `İndirim: %${val}`;
    });

    statusSelect2.addEventListener("change", () => {
        const val = statusSelect2.value === "true" ? "Aktif" : "Pasif";
        statusPreview2.textContent = `Durum: ${val}`;
    });

    descInput2.addEventListener("input", () => {
        descPreview2.textContent = descInput2.value?.trim() ? descInput2.value : "Açıklama";
    });
</script>
